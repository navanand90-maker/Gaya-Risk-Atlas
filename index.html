<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaya Risk Atlas v6.0 - Integrated Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg-dark: #1a1a1d; --panel-bg: #25252b; --accent: #ffd166; 
            --text: #e0e0e0; --border: #333;
        }
        body { margin: 0; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column; height: 100vh; background: var(--bg-dark); color: var(--text); overflow: hidden; }
        
        /* Header */
        header { background: #fff; color: #222; height: 60px; padding: 0 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--accent); z-index: 2000; }
        .brand h1 { font-size: 1.3rem; margin: 0; font-weight: 700; display: inline-block; }
        .brand span { background: #d32f2f; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; vertical-align: middle; margin-left: 10px; }
        .logos img { height: 40px; margin-left: 15px; }

        /* Layout */
        .container { display: flex; flex: 1; height: calc(100vh - 60px); }
        
        /* Sidebar */
        .sidebar { width: 400px; background: var(--bg-dark); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }

        /* Block Selector */
        .selector-box { background: var(--panel-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--accent); }
        .selector-box label { font-size: 0.8rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        select { width: 100%; padding: 10px; margin-top: 8px; background: #111; color: white; border: 1px solid #444; border-radius: 4px; font-family: inherit; }

        /* Block Profile Table */
        #block-profile { display: none; margin-top: 15px; }
        .profile-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .profile-table td { padding: 6px; border-bottom: 1px solid #333; }
        .profile-table td:first-child { color: #aaa; }
        .profile-table td:last-child { font-weight: 600; text-align: right; }
        .risk-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }

        /* Layer Buttons */
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: #888; letter-spacing: 1px; margin: 25px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .layer-btn { width: 100%; text-align: left; background: transparent; color: #ccc; padding: 12px; border: 1px solid #333; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .layer-btn:hover { background: #333; color: white; }
        .layer-btn.active { background: var(--accent); color: #111; font-weight: 600; border-color: var(--accent); }
        .layer-btn i { width: 25px; text-align: center; margin-right: 10px; }

        /* Dynamic Info Panel */
        .info-panel { background: var(--panel-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .info-panel h3 { margin: 0 0 5px 0; color: var(--accent); font-size: 1.1rem; }
        .info-panel p { font-size: 0.85rem; line-height: 1.5; color: #ccc; margin-bottom: 10px; }
        
        /* Risk Lists */
        .risk-list-box { background: #111; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto; font-size: 0.8rem; border: 1px solid #333; }
        .risk-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #222; }
        
        /* Legend */
        .legend-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; }

        /* Map */
        #map { flex: 1; background: #ddd; }
        .leaflet-tooltip.block-label { background: transparent; border: none; box-shadow: none; font-weight: 700; color: #333; text-shadow: 2px 2px 0px #fff; font-family: 'Poppins'; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <i class="fas fa-globe-asia" style="color:#d32f2f"></i>
        <h1>Gaya Risk Atlas</h1> <span>v6.0</span>
    </div>
    <div class="logos">
        <!-- Update these URLs to your local images if needed -->
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e9/Seal_of_Bihar.png" title="Govt of Bihar">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/United_Nations_Development_Programme_logo.svg/1200px-United_Nations_Development_Programme_logo.svg.png" title="UNDP">
    </div>
</header>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-content">
            
            <!-- 1. BLOCK SELECTOR (New Feature) -->
            <div class="selector-box">
                <label><i class="fas fa-search"></i> Block Wise Profile</label>
                <select id="blockDropdown" onchange="selectBlock(this.value)">
                    <option value="">-- Select a Block --</option>
                    <option disabled>Loading data...</option>
                </select>
                
                <div id="block-profile">
                    <h4 style="margin:10px 0 5px 0; color:white;" id="profile-title">Block Name</h4>
                    <table class="profile-table" id="profile-table-body">
                        <!-- Javascript will populate this -->
                    </table>
                </div>
            </div>

            <!-- 2. LAYER CONTROLS -->
            <div class="section-title">Risk Maps</div>
            <button class="layer-btn" onclick="activateLayer('multi')"><i class="fas fa-layer-group"></i> Multi-Hazard Prioritization</button>
            <button class="layer-btn" onclick="activateLayer('flood')"><i class="fas fa-water"></i> Flood Risk</button>
            <button class="layer-btn" onclick="activateLayer('drought')"><i class="fas fa-sun"></i> Drought Risk</button>
            <button class="layer-btn" onclick="activateLayer('heat')"><i class="fas fa-temperature-high"></i> Heatwave Risk</button>
            <button class="layer-btn" onclick="activateLayer('lightning')"><i class="fas fa-bolt"></i> Lightning Risk</button>
            <button class="layer-btn" onclick="activateLayer('quake')"><i class="fas fa-house-crack"></i> Earthquake Risk</button>
            <button class="layer-btn" onclick="activateLayer('fire')"><i class="fas fa-fire"></i> Fire Risk</button>

            <!-- 3. DYNAMIC INFO -->
            <div id="layer-details" style="display:none; margin-top: 20px;">
                <div class="info-panel">
                    <h3 id="info-title">Title</h3>
                    <p id="info-desc">Description</p>
                    
                    <label style="font-size:0.75rem; color:#888;">Legend</label>
                    <div class="legend-bar" id="legend-gradient"></div>
                    <div class="legend-labels">
                        <span>Low</span><span>Moderate</span><span>High</span><span>Very High</span>
                    </div>

                    <label style="font-size:0.75rem; color:#888; margin-top:15px; display:block;">Highest Risk Blocks</label>
                    <div class="risk-list-box" id="risk-list">
                        <!-- JS Populated -->
                    </div>
                </div>
            </div>

        </div>
    </aside>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. SETUP MAP ---
    var map = L.map('map', { zoomControl: false, center: [24.7914, 85.0002], zoom: 10 });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var labelPane = map.createPane('labels');
    labelPane.style.zIndex = 650;
    labelPane.style.pointerEvents = 'none';

    // Global Stores
    var globalData = {}; // Stores raw JSONs
    var currentGeoJsonLayer = null;
    var blockList = []; // List of block names

    // --- 2. CONFIGURATION ---
    var config = {
        'multi': { 
            file: 'data/multihazard.json', 
            title: "Multi-Hazard Prioritization", 
            desc: "A composite risk score combining flood, drought, heat, and seismic vulnerability. Uses weighted overlay methodology to identify blocks requiring urgent intervention.",
            colors: ['#388e3c', '#fbc02d', '#d32f2f', '#4a148c'], // Green -> Purple
            type: 'num'
        },
        'flood': { 
            file: 'data/flood.json', 
            title: "Flood Risk", 
            desc: "Based on geomorphic flood susceptibility and historical inundation frequency. High risk areas are concentrated near river banks.",
            colors: ['#e3f2fd', '#2196f3', '#0d47a1'],
            type: 'cat' 
        },
        'drought': { 
            file: 'data/drought.json', 
            title: "Drought Risk", 
            desc: "Agricultural drought analysis using vegetation health indices (VCI) and rainfall deviation. Southern blocks show higher susceptibility.",
            colors: ['#fff9c4', '#fbc02d', '#e65100'],
            type: 'cat'
        },
        'heat': { 
            file: 'data/heatwave.json', 
            title: "Heatwave Risk", 
            desc: "Land Surface Temperature (LST) analysis from peak summer months. Urban centers and barren rocky areas show extreme risk.",
            colors: ['#fff3e0', '#ff7043', '#bf360c'],
            type: 'num'
        },
        'lightning': { 
            file: 'data/lightning.json', 
            title: "Lightning Risk", 
            desc: "Density of lightning strikes and associated fatalities (2020-2024).",
            colors: ['#e8f5e9', '#66bb6a', '#1b5e20'],
            type: 'num'
        },
        'quake': { 
            file: 'data/earthquake.json', 
            title: "Earthquake Risk", 
            desc: "Seismic Zone Map overlaid with soil liquefaction potential.",
            colors: ['#efebe9', '#8d6e63', '#3e2723'],
            type: 'num'
        },
        'fire': { 
            file: 'data/fire.json', 
            title: "Fire Risk", 
            desc: "Forest fire susceptibility based on fuel load and historical fire points.",
            colors: ['#ffebee', '#e57373', '#b71c1c'],
            type: 'num'
        }
    };

    // --- 3. DATA LOADER & PROCESSOR ---

    // Initial load of all data for the Dropdown & Profile to work
    function preloadAllData() {
        var promises = Object.keys(config).map(key => {
            return fetch(config[key].file)
                .then(r => { if(r.ok) return r.json(); return null; })
                .then(json => {
                    if(json) {
                        // 1. Detect Value Column
                        var col = detectColumn(json.features[0].properties, key);
                        // 2. Normalize Data (Add a standard 'riskVal' property to features)
                        json.features.forEach(f => {
                            f.properties._cleanVal = parseValue(f.properties[col]);
                            f.properties._stdName = normalizeName(f.properties); // Normalize Block Name
                        });
                        // 3. Store
                        globalData[key] = { json: json, col: col };
                    }
                })
                .catch(e => console.warn("Missing: " + config[key].file));
        });

        Promise.all(promises).then(() => {
            initBlockDropdown();
            console.log("All Data Loaded");
        });
    }

    // Helper: Find the data column (Aggressive)
    function detectColumn(props, type) {
        var keys = Object.keys(props);
        var lower = keys.map(k => k.toLowerCase());
        
        // Priority checks
        if(type === 'multi') return keys.find(k => k.toLowerCase().includes('score') || k.toLowerCase().includes('risk')) || keys[0];
        if(type === 'lightning') return keys.find(k => k.toLowerCase().includes('total')) || keys[0];
        if(type === 'flood' || type === 'drought') return keys.find(k => k.toLowerCase().includes('grid')) || keys[0];
        
        // Fallback: Find first key that has a number value
        for(let k of keys) {
            if(typeof props[k] === 'number') return k;
        }
        return keys[0]; 
    }

    // Helper: Clean values (Handle "Very High" or "25.5")
    function parseValue(val) {
        if(val === undefined || val === null) return 0;
        if(typeof val === 'number') return val;
        
        // If string, try to extract number
        var num = parseFloat(val);
        if(!isNaN(num)) return num;

        // If categorical string
        var s = val.toLowerCase();
        if(s.includes('very high')) return 5;
        if(s.includes('high')) return 4;
        if(s.includes('mod')) return 3;
        if(s.includes('low')) return 2;
        return 1;
    }

    // Helper: Standardize Block Name
    function normalizeName(props) {
        var k = Object.keys(props).find(key => key.toLowerCase().includes('block')) || Object.keys(props)[0];
        return props[k] ? props[k].trim() : "Unknown";
    }

    // --- 4. MAP VISUALIZATION ---

    function activateLayer(key) {
        if(currentGeoJsonLayer) map.removeLayer(currentGeoJsonLayer);
        
        var dataset = globalData[key];
        if(!dataset) { alert("Data for " + config[key].title + " not loaded yet."); return; }

        // Calculate Stats for Color Scale
        var values = dataset.json.features.map(f => f.properties._cleanVal);
        var min = Math.min(...values);
        var max = Math.max(...values);
        if(min === max) { min=0; max=5; } // Fallback for categorical

        // Create Layer
        currentGeoJsonLayer = L.geoJson(dataset.json, {
            style: function(feature) {
                return {
                    fillColor: getColor(feature.properties._cleanVal, min, max, config[key].colors),
                    weight: 1,
                    color: 'white',
                    fillOpacity: 0.8
                };
            },
            onEachFeature: function(feature, layer) {
                // Label
                layer.bindTooltip(feature.properties._stdName, { permanent: true, direction:"center", className:"block-label", pane:"labels" });
                // Interaction
                layer.on('click', function() {
                    document.getElementById('blockDropdown').value = feature.properties._stdName;
                    selectBlock(feature.properties._stdName);
                });
            }
        }).addTo(map);

        map.fitBounds(currentGeoJsonLayer.getBounds());
        updateSidebar(key, dataset.json.features);
    }

    function getColor(val, min, max, palette) {
        // Simple Gradient Interpolation
        var pct = (val - min) / (max - min);
        if(pct < 0) pct = 0; if(pct > 1) pct = 1;

        if (palette.length === 3) {
            if(pct < 0.5) return palette[0];
            if(pct < 0.8) return palette[1];
            return palette[2];
        } else {
            // 4 color scale
            if(pct < 0.25) return palette[0];
            if(pct < 0.50) return palette[1];
            if(pct < 0.75) return palette[2];
            return palette[3];
        }
    }

    // --- 5. UI UPDATES ---

    function updateSidebar(key, features) {
        // Highlight Button
        document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
        // Find button by text content roughly (or modify HTML to have IDs)
        // Simplified:
        var cfg = config[key];
        
        document.getElementById('layer-details').style.display = 'block';
        document.getElementById('info-title').innerText = cfg.title;
        document.getElementById('info-desc').innerText = cfg.desc;
        
        // Legend Gradient
        var grad = `linear-gradient(90deg, ${cfg.colors.join(', ')})`;
        document.getElementById('legend-gradient').style.background = grad;

        // Generate High Risk List
        var listHTML = "";
        // Sort features by value descending
        var sorted = [...features].sort((a,b) => b.properties._cleanVal - a.properties._cleanVal);
        
        // Take top 5
        for(var i=0; i<8; i++) {
            if(sorted[i]) {
                var val = Math.round(sorted[i].properties._cleanVal * 10) / 10;
                listHTML += `<div class="risk-row">
                    <span>${sorted[i].properties._stdName}</span>
                    <span style="color:${cfg.colors[cfg.colors.length-1]}">${val}</span>
                </div>`;
            }
        }
        document.getElementById('risk-list').innerHTML = listHTML;
    }

    // --- 6. BLOCK PROFILE LOGIC ---

    function initBlockDropdown() {
        // Extract all unique block names from one of the datasets (e.g. Flood)
        if(!globalData['flood']) return;
        
        var names = globalData['flood'].json.features.map(f => f.properties._stdName).sort();
        blockList = [...new Set(names)]; // Unique
        
        var sel = document.getElementById('blockDropdown');
        sel.innerHTML = '<option value="">-- Select a Block --</option>';
        blockList.forEach(n => {
            sel.innerHTML += `<option value="${n}">${n}</option>`;
        });
    }

    function selectBlock(blockName) {
        if(!blockName) return;
        
        var profileDiv = document.getElementById('block-profile');
        var title = document.getElementById('profile-title');
        var tbody = document.getElementById('profile-table-body');
        
        profileDiv.style.display = 'block';
        title.innerText = blockName;
        tbody.innerHTML = "";

        // Loop through all hazards
        Object.keys(config).forEach(key => {
            var data = globalData[key];
            if(data) {
                // Find feature for this block
                var feature = data.json.features.find(f => f.properties._stdName === blockName);
                var val = "N/A";
                var color = "#666";
                var label = "No Data";

                if(feature) {
                    var raw = feature.properties._cleanVal;
                    // Determine simplified label based on relative range
                    // Note: Ideally we calculate percentiles, but simplified here:
                    label = raw.toFixed(2);
                    // Color code badge
                    color = getBadgeColor(key, raw);
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${config[key].title.replace(' Risk','')}</td>
                        <td><span class="risk-badge" style="background:${color}; color:#fff">${label}</span></td>
                    </tr>
                `;
            }
        });
    }

    function getBadgeColor(key, val) {
        // Approximate thresholds based on typical data
        // You might need to tune these based on your actual data ranges
        if(val > 4 || val > 100) return '#d32f2f'; // Red
        if(val > 2 || val > 50) return '#fbc02d';  // Yellow
        return '#388e3c'; // Green
    }

    // Start
    preloadAllData();

</script>
</body>
</html>