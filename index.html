<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaya District Risk Atlas</title>
    
    <!-- Modern Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg-dark: #1e1e24;
            --accent: #ffd166;
            --text-light: #f8f9fa;
            --text-muted: #adb5bd;
            --header-bg: #ffffff;
            --border-color: #2b2b36;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Poppins', sans-serif; 
            display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden; 
            background-color: var(--bg-dark);
        }

        /* --- HEADER --- */
        header {
            background-color: var(--header-bg);
            color: #333;
            height: 65px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            z-index: 2000;
            border-bottom: 3px solid var(--accent);
        }

        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 { font-size: 1.4rem; font-weight: 600; margin: 0; color: #111; }
        .brand span { font-size: 0.8rem; font-weight: 400; color: #666; background: #eee; padding: 4px 10px; border-radius: 20px; }
        
        .logos { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 45px; width: auto; vertical-align: middle; }

        /* --- CONTAINER & SIDEBAR --- */
        .container { display: flex; flex: 1; height: calc(100vh - 65px); }

        .sidebar {
            width: 380px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid #111;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .sidebar-scroll { padding: 25px; }

        .section-title {
            font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);
            letter-spacing: 1.5px; margin-bottom: 15px; margin-top: 10px;
            font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;
        }

        .info-card {
            background: #2b2b36; padding: 20px; border-radius: 12px; margin-bottom: 30px;
            border-left: 4px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .info-card h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--accent); }
        .info-card p { font-size: 0.9rem; line-height: 1.6; color: #e0e0e0; margin: 0; font-weight: 300; }

        /* --- LEGEND --- */
        .legend-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
            background: #25252f; padding: 15px; border-radius: 8px;
        }
        .legend-item { display: flex; align-items: center; font-size: 0.8rem; color: #ddd; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }

        /* --- BUTTONS --- */
        .nav-grid { display: flex; flex-direction: column; gap: 8px; }
        .layer-btn {
            display: flex; align-items: center; width: 100%; padding: 14px 20px;
            background: transparent; border: 1px solid var(--border-color); border-radius: 8px;
            color: var(--text-muted); font-family: 'Poppins', sans-serif; font-size: 0.95rem;
            cursor: pointer; transition: all 0.3s ease;
        }
        .layer-btn:hover { background: rgba(255, 255, 255, 0.05); color: white; border-color: #555; }
        .layer-btn.active {
            background-color: var(--accent); color: #1a1a1a; border-color: var(--accent);
            font-weight: 600; box-shadow: 0 0 15px rgba(255, 209, 102, 0.4); transform: scale(1.02);
        }
        .layer-btn.active i { color: #1a1a1a; }
        .layer-btn i { width: 25px; text-align: center; margin-right: 15px; font-size: 1.1rem; }

        /* --- MAP & LABELS (THE FIX) --- */
        #map { flex: 1; background-color: #e5e5e5; }

        /* This removes the white box and makes the label look clean */
        .leaflet-tooltip.block-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 10px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; /* White Halo */
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="brand">
            <i class="fas fa-layer-group fa-lg" style="color: #1a1a1a;"></i>
            <div><h1>Risk Atlas</h1></div>
            <span>Gaya District</span>
        </div>
        <div class="logos">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e9/Seal_of_Bihar.png" class="logo-img" title="Government of Bihar">
            <!-- Ensure this file exists in your GitHub repo! -->
            <img src="bsdma_logo.jpg" class="logo-img" onerror="this.style.display='none'" title="BSDMA">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/United_Nations_Development_Programme_logo.svg/1200px-United_Nations_Development_Programme_logo.svg.png" class="logo-img" title="UNDP">
        </div>
    </header>

    <!-- CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-scroll">
                <div class="info-card" id="dynamic-content">
                    <h2>Welcome</h2>
                    <p>Select a hazard layer to analyze risk distribution. This digital atlas supports decision-making for disaster resilience in Gaya.</p>
                </div>
                <div id="legend-wrapper" style="display:none; margin-bottom: 30px;">
                    <div class="section-title">Legend</div>
                    <div id="dynamic-legend" class="legend-grid"></div>
                </div>
                <div class="section-title">Multi-Hazard Overview</div>
                <div class="nav-grid">
                    <button class="layer-btn" onclick="toggleLayer('multi')"><i class="fas fa-globe-asia"></i> Multi-Hazard Index</button>
                </div>
                <div class="section-title" style="margin-top: 25px;">Natural Hazards</div>
                <div class="nav-grid">
                    <button class="layer-btn" onclick="toggleLayer('flood')"><i class="fas fa-water"></i> Flood Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('drought')"><i class="fas fa-sun"></i> Drought Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('heat')"><i class="fas fa-temperature-high"></i> Heatwave Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('lightning')"><i class="fas fa-bolt"></i> Lightning Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('quake')"><i class="fas fa-house-crack"></i> Earthquake Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('fire')"><i class="fas fa-fire"></i> Fire Risk</button>
                </div>
                <div class="section-title" style="margin-top: 25px;">Vulnerability</div>
                <div class="nav-grid">
                    <button class="layer-btn" onclick="toggleLayer('pop')"><i class="fas fa-users"></i> Population Density</button>
                    <button class="layer-btn" onclick="toggleLayer('land')"><i class="fas fa-tree"></i> Landuse Map</button>
                </div>
            </div>
        </aside>
        <div id="map"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. MAP INIT
        var map = L.map('map', { zoomControl: false }).setView([24.7914, 85.0002], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CartoDB'
        }).addTo(map);

        // 2. DATA CONFIG
        var layerInfo = {
            'multi': { title: "Multi-Hazard Context", desc: "Gaya district is exposed to multiple natural hazards. Risk is unevenly distributed across blocks.", legend: [{col:'#b91c1c', lbl:'Very High'}, {col:'#d32f2f', lbl:'High'}, {col:'#f57f17', lbl:'Moderate'}, {col:'#388e3c', lbl:'Low'}] },
            'flood': { title: "Flood Risk Analysis", desc: "Recurrent monsoon flooding affects Manpur, Bodh Gaya, and Atri due to river overflow.", legend: [{col:'#d32f2f', lbl:'High Risk'}, {col:'#f57f17', lbl:'Moderate Risk'}, {col:'#388e3c', lbl:'Low Risk'}] },
            'drought': { title: "Drought Risk Analysis", desc: "Southern blocks face water stress and groundwater depletion.", legend: [{col:'#d32f2f', lbl:'High Risk'}, {col:'#f57f17', lbl:'Moderate Risk'}, {col:'#388e3c', lbl:'Low Risk'}] },
            'heat': { title: "Heatwave Risk", desc: "Extreme heat events in urban areas exceed safe thresholds.", legend: [{col:'#b91c1c', lbl:'Very High'}, {col:'#d32f2f', lbl:'High'}, {col:'#f57f17', lbl:'Moderate'}] },
            'lightning': { title: "Lightning Risk", desc: "High fatality risk in rural blocks during pre-monsoon storms.", legend: [{col:'#d32f2f', lbl:'High Risk'}, {col:'#f57f17', lbl:'Moderate Risk'}, {col:'#388e3c', lbl:'Low Risk'}] },
            'quake': { title: "Earthquake Risk", desc: "Moderate seismic zone. Dense settlements are vulnerable.", legend: [{col:'#f57f17', lbl:'Moderate Zone'}, {col:'#388e3c', lbl:'Low Zone'}] },
            'fire': { title: "Fire Risk", desc: "Urban wards and dense villages face high fire risk.", legend: [{col:'#d32f2f', lbl:'High Risk'}, {col:'#f57f17', lbl:'Moderate Risk'}, {col:'#388e3c', lbl:'Low Risk'}] },
            'pop': { title: "Population Density", desc: "Visualizes population concentration for evacuation planning.", legend: [{col:'#08306b', lbl:'Very High'}, {col:'#4292c6', lbl:'High'}, {col:'#deebf7', lbl:'Low'}] },
            'land': { title: "Landuse Map", desc: "Classification of built-up, agriculture, and forest areas.", legend: [{col:'#b71c1c', lbl:'Builtup'}, {col:'#fbc02d', lbl:'Agriculture'}, {col:'#1b5e20', lbl:'Forest'}] }
        };

        // 3. COLOR LOGIC
        function getRiskColor(d) {
            if (!d) return '#ccc';
            var val = d.toString().toLowerCase();
            if (val.includes('very high')) return '#b91c1c';
            if (val.includes('high')) return '#d32f2f';
            if (val.includes('mod')) return '#f57f17';
            if (val.includes('low')) return '#388e3c';
            return '#ccc';
        }
        function getPopColor(d) {
            // Updated thresholds for Gaya population range
            var num = parseFloat(d);
            if (isNaN(num)) return '#ccc';
            return num > 250000 ? '#08306b' : num > 150000 ? '#08519c' : num > 100000 ? '#2171b5' : num > 50000 ? '#6baed6' : '#deebf7';
        }
        function getLandColor(d) {
            if (!d) return '#ccc';
            var val = d.toString().toLowerCase();
            if (val.includes('built')) return '#b71c1c';
            if (val.includes('agri')) return '#fbc02d';
            if (val.includes('forest')) return '#1b5e20';
            return '#ccc';
        }

        // 4. LAYER FACTORY
        var layers = {};
        var currentLayer = null;

        function createLayer(url, type, colName) {
            var lyr = L.geoJson(null, {
                style: function(feature) {
                    var val = feature.properties[colName];
                    var col = type === 'risk' ? getRiskColor(val) : type === 'pop' ? getPopColor(val) : getLandColor(val);
                    return { fillColor: col, weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7 };
                },
                onEachFeature: function(feature, layer) {
                    var props = feature.properties;
                    // FIX 1: Look for "Blocks" as the name key based on your file
                    var bName = props.Blocks || props.Block_Name || props.BLOCK_NAME || "Block"; 
                    
                    // FIX 2: Add Transparent Tooltip (The Name Label)
                    layer.bindTooltip(bName, {
                        permanent: true,
                        direction: "center",
                        className: "block-label" // This class is defined in CSS to be transparent
                    });

                    // FIX 3: Popup reads the specific column
                    var displayVal = props[colName];
                    if (displayVal === undefined || displayVal === null) displayVal = "No Data";
                    else if (type === 'pop') displayVal = Math.round(displayVal).toLocaleString(); // Format number with commas

                    var popup = `<div style="font-family:'Poppins';">
                                    <h4 style="margin:0 0 5px 0;">${bName}</h4>
                                    <span style="font-size:0.9rem; color:#555;">
                                        Value: <b>${displayVal}</b>
                                    </span>
                                 </div>`;
                    layer.bindPopup(popup);
                }
            });
            fetch(url).then(r => r.json()).then(d => lyr.addData(d)).catch(e => console.log('Pending: ' + url));
            return lyr;
        }

        // 5. INITIALIZE LAYERS
        // Using "Pop" because your JSON showed "Pop":288595
        layers['pop'] = createLayer('data/population.json', 'pop', 'Pop');
        
        // Ensure these column names match your other files later!
        layers['multi'] = createLayer('data/multihazard.json', 'risk', 'Risk_Class');
        layers['flood'] = createLayer('data/flood.json', 'risk', 'Risk_Class');
        layers['drought'] = createLayer('data/drought.json', 'risk', 'Risk_Class');
        layers['heat'] = createLayer('data/heatwave.json', 'risk', 'Risk_Class');
        layers['lightning'] = createLayer('data/lightning.json', 'risk', 'Risk_Class');
        layers['quake'] = createLayer('data/earthquake.json', 'risk', 'Risk_Class');
        layers['fire'] = createLayer('data/fire.json', 'risk', 'Risk_Class');
        layers['land'] = createLayer('data/landuse.json', 'land', 'Landuse_Class');

        // 6. INTERACTION
        function toggleLayer(id) {
            if (currentLayer) map.removeLayer(currentLayer);
            if (layers[id]) {
                currentLayer = layers[id];
                map.addLayer(currentLayer);
                if (currentLayer.getLayers().length > 0) map.fitBounds(currentLayer.getBounds());
            }
            updateUI(id);
        }

        function updateUI(id) {
            var data = layerInfo[id];
            document.getElementById('dynamic-content').innerHTML = `<h2>${data.title}</h2><p>${data.desc}</p>`;
            var legWrap = document.getElementById('legend-wrapper');
            var legBox = document.getElementById('dynamic-legend');
            legWrap.style.display = 'block';
            legBox.innerHTML = '';
            data.legend.forEach(item => {
                legBox.innerHTML += `<div class="legend-item"><div class="color-dot" style="background:${item.col}"></div>${item.lbl}</div>`;
            });
            document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>