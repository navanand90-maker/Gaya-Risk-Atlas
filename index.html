<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaya District Risk Atlas v5.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg-dark: #1e1e24; --accent: #ffd166; --text-light: #f8f9fa;
            --text-muted: #adb5bd; --header-bg: #ffffff; --border-color: #2b2b36;
        }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: var(--bg-dark); }
        
        header { background-color: var(--header-bg); color: #333; height: 65px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 2000; border-bottom: 3px solid var(--accent); }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 { font-size: 1.4rem; font-weight: 600; margin: 0; color: #111; }
        .brand span { font-size: 0.8rem; font-weight: 700; color: white; background: #d32f2f; padding: 4px 10px; border-radius: 20px; } 
        .logos { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 45px; width: auto; vertical-align: middle; }

        .container { display: flex; flex: 1; height: calc(100vh - 65px); }
        .sidebar { width: 380px; background-color: var(--bg-dark); color: var(--text-light); display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid #111; box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 1000; }
        .sidebar-scroll { padding: 25px; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1.5px; margin-bottom: 15px; margin-top: 10px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        
        .info-card { background: #2b2b36; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .info-card h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--accent); }
        .info-card p { font-size: 0.9rem; line-height: 1.6; color: #e0e0e0; margin: 0; font-weight: 300; }

        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; background: #25252f; padding: 15px; border-radius: 8px; }
        .legend-item { display: flex; align-items: center; font-size: 0.8rem; color: #ddd; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }

        .nav-grid { display: flex; flex-direction: column; gap: 8px; }
        .layer-btn { display: flex; align-items: center; width: 100%; padding: 14px 20px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-muted); font-family: 'Poppins', sans-serif; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; }
        .layer-btn:hover { background: rgba(255, 255, 255, 0.05); color: white; border-color: #555; }
        .layer-btn.active { background-color: var(--accent); color: #1a1a1a; border-color: var(--accent); font-weight: 600; box-shadow: 0 0 15px rgba(255, 209, 102, 0.4); transform: scale(1.02); }
        .layer-btn i { width: 25px; text-align: center; margin-right: 15px; font-size: 1.1rem; }
        .layer-btn.active i { color: #1a1a1a; }

        #map { flex: 1; background-color: #e5e5e5; }
        /* Label Styling */
        .leaflet-tooltip.block-label { 
            background: transparent !important; border: none !important; box-shadow: none !important; 
            font-size: 10px; font-weight: 700; color: #222; text-transform: uppercase; 
            text-shadow: -1.5px -1.5px 0 #fff, 1.5px -1.5px 0 #fff, -1.5px 1.5px 0 #fff, 1.5px 1.5px 0 #fff; 
            font-family: 'Poppins', sans-serif; pointer-events: none;
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-layer-group fa-lg" style="color: #1a1a1a;"></i>
            <div><h1>Risk Atlas</h1></div>
            <span>v5.1</span>
        </div>
        <div class="logos">
            <!-- Replace these with actual paths if local, or keep URLs -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e9/Seal_of_Bihar.png" class="logo-img" title="Government of Bihar">
            <img src="bsdma_logo.jpg" class="logo-img" onerror="this.style.display='none'" title="BSDMA">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/United_Nations_Development_Programme_logo.svg/1200px-United_Nations_Development_Programme_logo.svg.png" class="logo-img" title="UNDP">
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-scroll">
                <div class="info-card" id="dynamic-content">
                    <h2>Welcome</h2>
                    <p>Select a hazard layer to analyze risk distribution. This digital atlas supports decision-making for disaster resilience in Gaya.</p>
                </div>
                
                <div id="legend-wrapper" style="display:none; margin-bottom: 30px;">
                    <div class="section-title">Legend</div>
                    <div id="dynamic-legend" class="legend-grid"></div>
                </div>

                <div class="section-title">Natural Hazards</div>
                <div class="nav-grid">
                    <button class="layer-btn" onclick="toggleLayer('flood')"><i class="fas fa-water"></i> Flood Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('drought')"><i class="fas fa-sun"></i> Drought Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('heat')"><i class="fas fa-temperature-high"></i> Heatwave Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('lightning')"><i class="fas fa-bolt"></i> Lightning Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('quake')"><i class="fas fa-house-crack"></i> Earthquake Risk</button>
                    <button class="layer-btn" onclick="toggleLayer('fire')"><i class="fas fa-fire"></i> Fire Risk</button>
                </div>

                <div class="section-title" style="margin-top: 25px;">Vulnerability</div>
                <div class="nav-grid">
                    <button class="layer-btn" onclick="toggleLayer('pop')"><i class="fas fa-users"></i> Population Density</button>
                    <button class="layer-btn" onclick="toggleLayer('land')"><i class="fas fa-tree"></i> Landuse Map</button>
                </div>
            </div>
        </aside>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- BASE MAP CONFIG ---
        var lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap, © CartoDB' });
        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });

        var map = L.map('map', { 
            zoomControl: false, 
            layers: [lightMap],
            center: [24.7914, 85.0002], 
            zoom: 10 
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.control.layers({ "Clean Map": lightMap, "Satellite": satelliteMap }, null, { position: 'topright' }).addTo(map);

        // --- MASTER LABEL PANE (Keeps labels on top of colored polygons) ---
        map.createPane('labels');
        map.getPane('labels').style.zIndex = 650;
        map.getPane('labels').style.pointerEvents = 'none';

        var masterLabelLayer = L.geoJson(null, {
            style: { color: '#333', weight: 0.5, fillOpacity: 0 }, 
            onEachFeature: function(feature, layer) {
                var props = feature.properties;
                // Try multiple variations for Name column
                var nameKey = Object.keys(props).find(k => k.toLowerCase().includes('block')) || Object.keys(props)[0];
                var bName = props[nameKey] || "Block";
                
                layer.bindTooltip(bName, { permanent: true, direction: "center", className: "block-label", pane: "labels" });
            }
        });
        
        // Load boundary data for labels (Using population file as it usually has boundaries)
        fetch('data/population.json')
            .then(r => r.json())
            .then(d => { masterLabelLayer.addData(d); })
            .catch(e => console.log("Note: Boundaries not loaded yet (Check data/population.json)"));

        // --- COLOR SCHEMES & LEGEND DATA ---
        var legendStandard = [
            {col:'#4a148c', lbl:'Very High'}, 
            {col:'#d32f2f', lbl:'High'}, 
            {col:'#f57f17', lbl:'Moderate'}, 
            {col:'#388e3c', lbl:'Low'}
        ];
        
        var layerInfo = {
            'flood': { title: "Flood Risk", desc: "Monsoon flooding analysis based on grid code methodology.", legend: legendStandard },
            'drought': { title: "Drought Risk", desc: "Agricultural drought vulnerability.", legend: legendStandard },
            'heat': { title: "Heatwave Risk", desc: "Land Surface Temperature (LST) derived zones.", legend: legendStandard },
            'lightning': { title: "Lightning Risk", desc: "Fatality counts (2022-2025).", legend: [{col:'#4a148c', lbl:'> 9 (Very High)'}, {col:'#d32f2f', lbl:'6 - 9 (High)'}, {col:'#f57f17', lbl:'3 - 6 (Moderate)'}, {col:'#388e3c', lbl:'< 3 (Low)'}] },
            'quake': { title: "Earthquake Risk", desc: "Seismic vulnerability index.", legend: legendStandard },
            'fire': { title: "Fire Risk", desc: "Fire susceptibility index.", legend: legendStandard },
            'pop': { title: "Population Density", desc: "Total population distribution.", legend: [{col:'#08306b', lbl:'Very High'}, {col:'#4292c6', lbl:'High'}, {col:'#deebf7', lbl:'Low'}] },
            'land': { title: "Landuse", desc: "Land cover classification.", legend: [{col:'#b71c1c', lbl:'Builtup'}, {col:'#fbc02d', lbl:'Agriculture'}, {col:'#1b5e20', lbl:'Forest'}, {col:'#2196f3', lbl:'Water'}] }
        };

        // --- 1. SMART COLUMN DETECTOR (Fixes the undefined data issue) ---
        function detectColumn(props, type) {
            var keys = Object.keys(props);
            var lowerKeys = keys.map(k => k.toLowerCase());

            function find(terms) {
                for (let term of terms) {
                    let idx = lowerKeys.indexOf(term.toLowerCase());
                    if (idx > -1) return keys[idx]; // Return the actual case-sensitive key
                }
                return null;
            }

            if (type === 'lightning') return find(['Total', 'Deaths', 'Fatalities']) || 'Total';
            if (type === 'flood' || type === 'drought') return find(['gridcode', 'grid_code', 'grid', 'class', 'risk_class']) || 'gridcode';
            if (type === 'pop') return find(['pop', 'population', 'p_total', 'total_pop']) || 'Pop';
            if (type === 'land') return find(['landuse', 'lulc', 'class', 'type']) || 'gridcode';
            
            // Fallback for generic numerical layers (Heat, Fire, Quake)
            return find(['mean', '_mean', 'sum', '_sum', 'total', 'risk_score', 'value', 'gridcode']) || keys[0];
        }

        // --- 2. STATS CALCULATOR (Fixes range issues) ---
        function calculateStats(data, colName) {
            var vals = [];
            data.features.forEach(f => {
                var val = f.properties[colName];
                if (val !== null && val !== undefined && val !== "") {
                    var num = parseFloat(val);
                    if (!isNaN(num)) vals.push(num);
                }
            });

            if (vals.length === 0) return { min: 0, max: 1 };
            
            var min = Math.min(...vals);
            var max = Math.max(...vals);
            
            // Avoid zero division
            if (min === max) { min = min - 1; max = max + 1; }
            
            console.log(`Stats [${colName}]: Min ${min}, Max ${max}`);
            return { min: min, max: max };
        }

        // --- 3. COLORING LOGIC (The Paint Brush) ---
        
        function getLightningColor(d) {
            var num = parseFloat(d);
            if (isNaN(num)) return '#ccc';
            if (num > 9) return '#4a148c'; 
            if (num >= 6) return '#d32f2f'; 
            if (num >= 3) return '#f57f17'; 
            return '#388e3c'; 
        }

        function getCatColor(d) {
            // Handles GridCodes (1-5) and Text (High/Low)
            if (d === undefined || d === null) return '#ccc';
            
            var num = parseFloat(d);
            if (!isNaN(num)) {
                if (num >= 5) return '#4a148c'; 
                if (num >= 4) return '#d32f2f'; 
                if (num >= 3) return '#f57f17'; 
                if (num <= 2) return '#388e3c'; 
            }
            
            var str = String(d).toLowerCase();
            if (str.includes('very') || str.includes('severe')) return '#4a148c';
            if (str.includes('high')) return '#d32f2f';
            if (str.includes('mod') || str.includes('med')) return '#f57f17';
            if (str.includes('low')) return '#388e3c';
            return '#ccc';
        }

        function getDynamicColor(d, min, max) {
            var num = parseFloat(d);
            if (isNaN(num)) return '#ccc';
            
            var pct = (num - min) / (max - min); 
            if (pct > 0.80) return '#4a148c'; 
            if (pct > 0.60) return '#d32f2f';
            if (pct > 0.40) return '#f57f17';
            if (pct > 0.20) return '#fdd835';
            return '#388e3c'; 
        }

        function getPopColor(d) {
             var num = parseFloat(d);
             if (isNaN(num)) return '#ccc';
             return num > 250000 ? '#08306b' : num > 150000 ? '#08519c' : num > 100000 ? '#2171b5' : num > 50000 ? '#6baed6' : '#deebf7';
        }
        
        function getLandColor(d) {
            if (!d) return '#ccc';
            var val = String(d).toLowerCase();
            if (val.includes('built') || val.includes('urban')) return '#b71c1c';
            if (val.includes('agri') || val.includes('crop')) return '#fbc02d';
            if (val.includes('forest') || val.includes('veg')) return '#1b5e20';
            if (val.includes('water')) return '#2196f3';
            return '#eee';
        }

        // --- LAYER MANAGER ---
        var layers = {};
        var currentLayer = null;

        function createLayer(url, logicType) {
            var lyr = L.geoJson(null, {});
            
            fetch(url).then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
            .then(data => {
                if (!data.features || data.features.length === 0) return;

                // 1. Detect which column to use
                var colName = detectColumn(data.features[0].properties, logicType);
                console.log(`Loaded ${url} -> Column: ${colName}`);

                // 2. Calculate Stats if numerical
                var stats = { min: 0, max: 1 };
                if (logicType === 'num' || logicType === 'pop') {
                    stats = calculateStats(data, colName);
                }

                // 3. Apply Style
                lyr.options.style = function(feature) {
                    var val = feature.properties[colName];
                    var col = '#ccc'; // Default grey
                    try {
                        if (logicType === 'lightning') col = getLightningColor(val);
                        else if (logicType === 'cat') col = getCatColor(val);
                        else if (logicType === 'land') col = getLandColor(val);
                        else if (logicType === 'pop') col = getPopColor(val);
                        else if (logicType === 'num') col = getDynamicColor(val, stats.min, stats.max);
                    } catch(e) { console.warn("Style error", e); }

                    return { fillColor: col, weight: 1, opacity: 1, color: 'white', fillOpacity: 0.8 };
                };

                // 4. Bind Popups
                lyr.eachLayer(function(layer) {
                    var props = layer.feature.properties;
                    var nameKey = Object.keys(props).find(k => k.toLowerCase().includes('block')) || "Block";
                    var val = props[colName];
                    if(typeof val === 'number') val = Math.round(val * 100) / 100;

                    layer.bindPopup(`
                        <div style="font-family:'Poppins'">
                            <h4 style="margin:0 0 5px 0">${props[nameKey]}</h4>
                            <span>Data: <b>${colName}</b></span><br>
                            <span>Value: <b>${val}</b></span>
                        </div>
                    `);
                });

                lyr.addData(data);
            })
            .catch(e => console.error('Failed to load ' + url, e));
            
            return lyr;
        }

        // --- INITIALIZE DATASETS ---
        // Ensure these files exist in your "data" folder
        layers['pop'] = createLayer('data/population.json', 'pop');
        layers['flood'] = createLayer('data/flood.json', 'cat');     
        layers['drought'] = createLayer('data/drought.json', 'cat'); 
        layers['heat'] = createLayer('data/heatwave.json', 'num');
        layers['lightning'] = createLayer('data/lightning.json', 'lightning'); 
        layers['fire'] = createLayer('data/fire.json', 'num');
        layers['quake'] = createLayer('data/earthquake.json', 'num');
        layers['land'] = createLayer('data/landuse.json', 'land');

        // --- USER INTERACTION ---
        function toggleLayer(id) {
            // Remove current layer
            if (currentLayer && map.hasLayer(currentLayer)) {
                map.removeLayer(currentLayer);
            }
            
            // Add new layer
            if (layers[id]) {
                currentLayer = layers[id];
                map.addLayer(currentLayer);
                
                // If the layer has data, zoom to it
                if (currentLayer.getLayers().length > 0) {
                    map.fitBounds(currentLayer.getBounds());
                }
            }

            // Ensure Labels stay on top
            if (!map.hasLayer(masterLabelLayer)) masterLabelLayer.addTo(map);
            masterLabelLayer.bringToFront();
            
            updateUI(id);
        }

        function updateUI(id) {
            // Update Sidebar Info
            var data = layerInfo[id];
            var contentDiv = document.getElementById('dynamic-content');
            var legendDiv = document.getElementById('dynamic-legend');
            var wrapper = document.getElementById('legend-wrapper');

            if (data) {
                contentDiv.innerHTML = `<h2>${data.title}</h2><p>${data.desc}</p>`;
                wrapper.style.display = 'block';
                legendDiv.innerHTML = '';
                data.legend.forEach(item => {
                    legendDiv.innerHTML += `<div class="legend-item"><div class="color-dot" style="background:${item.col}"></div>${item.lbl}</div>`;
                });
            }

            // Update Active Button State
            document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
            if(event) event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>