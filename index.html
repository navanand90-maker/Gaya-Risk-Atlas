<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaya Risk Atlas v7.0 - Precision Focus</title>
    
    <!-- Fonts: Inter for UI, Roboto Slab for Headers -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg-dark: #121212; 
            --panel-bg: #1e1e1e; 
            --accent: #00bcd4; /* Cyan accent for visibility against dark */
            --text-main: #e0e0e0;
            --border: #333;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; height: 100vh; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }
        
        /* HEADER */
        header { background: #222; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--accent); z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 { font-family: 'Roboto Slab', serif; font-size: 1.4rem; margin: 0; letter-spacing: 0.5px; color: #fff; }
        .tag { background: var(--accent); color: #000; font-weight: 700; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; }
        .logos img { height: 38px; margin-left: 10px; opacity: 0.9; transition: opacity 0.3s; }
        .logos img:hover { opacity: 1; }

        /* LAYOUT */
        .container { display: flex; flex: 1; height: calc(100vh - 60px); }
        
        /* SIDEBAR */
        .sidebar { width: 380px; background: var(--panel-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; overflow-y: auto; }
        .sidebar-pad { padding: 20px; }

        /* SECTIONS */
        .mode-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .section-header { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.5px; color: #888; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .section-header i { color: var(--accent); }

        /* BUTTONS */
        .grid-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .layer-btn { background: #2a2a2a; color: #ccc; border: 1px solid #444; padding: 10px 12px; border-radius: 6px; cursor: pointer; text-align: left; font-size: 0.85rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .layer-btn:hover { background: #333; border-color: #666; color: #fff; }
        .layer-btn.active { background: rgba(0, 188, 212, 0.15); border-color: var(--accent); color: var(--accent); font-weight: 600; }
        
        /* DROPDOWN */
        .block-select-wrapper { position: relative; }
        select { width: 100%; padding: 12px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; font-family: 'Inter'; font-size: 0.9rem; appearance: none; cursor: pointer; }
        select:focus { outline: none; border-color: var(--accent); }
        .select-arrow { position: absolute; right: 15px; top: 15px; pointer-events: none; color: var(--accent); font-size: 0.8rem; }

        /* LEGEND PANEL */
        #active-legend { background: #151515; padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent); margin-top: 20px; display: none; }
        #legend-title { font-family: 'Roboto Slab'; font-size: 1rem; color: #fff; margin: 0 0 5px 0; }
        #legend-desc { font-size: 0.8rem; color: #aaa; line-height: 1.4; margin-bottom: 10px; }
        .gradient-bar { height: 8px; width: 100%; border-radius: 4px; margin: 8px 0; background: #333; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #777; }

        /* MAP */
        #map { flex: 1; background: #222; }
        
        /* LEAFLET CUSTOMIZATIONS */
        .leaflet-tooltip { 
            background: rgba(0,0,0,0.8); border: 1px solid var(--accent); color: #fff; 
            font-family: 'Inter'; font-size: 11px; border-radius: 4px; padding: 4px 8px;
        }
        .leaflet-tooltip-left:before { border-left-color: rgba(0,0,0,0.8); }
        .leaflet-tooltip-right:before { border-right-color: rgba(0,0,0,0.8); }
        
        /* Special class for the focused block label */
        .focus-label {
            background: var(--accent) !important; color: #000 !important; font-weight: 700 !important;
            font-size: 12px !important; box-shadow: 0 2px 10px rgba(0,188,212,0.5);
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <i class="fas fa-layer-group fa-lg" style="color:var(--accent)"></i>
        <div><h1>Gaya Risk Atlas</h1></div>
        <span class="tag">v7.0</span>
    </div>
    <div class="logos">
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e9/Seal_of_Bihar.png" alt="Bihar">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/United_Nations_Development_Programme_logo.svg/1200px-United_Nations_Development_Programme_logo.svg.png" alt="UNDP">
    </div>
</header>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-pad">
            
            <!-- SECTION 1: DISTRICT LEVEL -->
            <div class="mode-section">
                <div class="section-header"><i class="fas fa-map"></i> 1. District Level Analysis</div>
                <div class="grid-buttons">
                    <button class="layer-btn" onclick="setMode('multi', null)"><i class="fas fa-biohazard"></i> Multi-Hazard</button>
                    <button class="layer-btn" onclick="setMode('flood', null)"><i class="fas fa-water"></i> Flood</button>
                    <button class="layer-btn" onclick="setMode('drought', null)"><i class="fas fa-sun"></i> Drought</button>
                    <button class="layer-btn" onclick="setMode('heat', null)"><i class="fas fa-temperature-high"></i> Heatwave</button>
                    <button class="layer-btn" onclick="setMode('lightning', null)"><i class="fas fa-bolt"></i> Lightning</button>
                    <button class="layer-btn" onclick="setMode('quake', null)"><i class="fas fa-house-crack"></i> Earthquake</button>
                    <button class="layer-btn" onclick="setMode('fire', null)"><i class="fas fa-fire"></i> Fire</button>
                    <button class="layer-btn" onclick="resetMap()"><i class="fas fa-times"></i> Clear Map</button>
                </div>
            </div>

            <!-- SECTION 2: BLOCK FOCUS -->
            <div class="mode-section" style="border-bottom:none;">
                <div class="section-header"><i class="fas fa-crosshairs"></i> 2. Block Focus Mode</div>
                <div style="margin-bottom:15px; color:#999; font-size:0.8rem;">
                    Select a block to isolate its risk profile. The map will dim the surrounding areas.
                </div>
                <div class="block-select-wrapper">
                    <select id="blockDropdown" onchange="focusBlock(this.value)">
                        <option value="">-- Select Block to Focus --</option>
                        <option disabled>Loading blocks...</option>
                    </select>
                    <div class="select-arrow"><i class="fas fa-chevron-down"></i></div>
                </div>
            </div>

            <!-- DYNAMIC LEGEND & INFO -->
            <div id="active-legend">
                <h3 id="legend-title">Hazard Title</h3>
                <p id="legend-desc">Description of the hazard goes here.</p>
                <div class="gradient-bar" id="legend-bar"></div>
                <div class="legend-labels">
                    <span>Low</span><span>Moderate</span><span>High</span><span>Severe</span>
                </div>
                <div id="block-val-display" style="margin-top:15px; font-size:0.9rem; border-top:1px solid #333; padding-top:10px; display:none;">
                    Selected Block Value: <b style="color:var(--accent)" id="val-placeholder">--</b>
                </div>
            </div>

        </div>
    </aside>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. MAP INITIALIZATION ---
    // Note: 'satellite' layer is active by default to ensure background image doesn't vanish
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri',
        opacity: 1.0
    });
    var streets = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© CartoDB'
    });

    var map = L.map('map', {
        center: [24.7914, 85.0002],
        zoom: 10,
        layers: [satellite], // Default to satellite
        zoomControl: false
    });

    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.control.layers({ "Satellite": satellite, "Dark Canvas": streets }, null, { position: 'bottomright' }).addTo(map);

    // --- 2. GLOBAL STATE ---
    var appState = {
        activeLayerKey: null,
        activeBlock: null,
        dataStore: {},
        geoLayer: null
    };

    var config = {
        'multi': { file: 'data/multihazard.json', title: "Multi-Hazard Priority", desc: "Combined composite risk score. Darker areas indicate overlapping high risks.", colors: ['#4caf50', '#ffeb3b', '#ff9800', '#f44336', '#4a148c'] },
        'flood': { file: 'data/flood.json', title: "Flood Risk", desc: "Susceptibility based on geomorphology and historic inundation.", colors: ['#e1f5fe', '#29b6f6', '#0277bd', '#01579b'] },
        'drought': { file: 'data/drought.json', title: "Drought Risk", desc: "Agricultural vulnerability based on VCI and rainfall deviation.", colors: ['#fffde7', '#fff176', '#ffb74d', '#e65100'] },
        'heat': { file: 'data/heatwave.json', title: "Heatwave Risk", desc: "Land Surface Temperature analysis.", colors: ['#fff3e0', '#ff8a65', '#d84315', '#bf360c'] },
        'lightning': { file: 'data/lightning.json', title: "Lightning Risk", desc: "Strike density and fatality reports.", colors: ['#f1f8e9', '#aed581', '#558b2f', '#33691e'] },
        'quake': { file: 'data/earthquake.json', title: "Earthquake Risk", desc: "Seismic zone vulnerability.", colors: ['#efebe9', '#a1887f', '#5d4037', '#3e2723'] },
        'fire': { file: 'data/fire.json', title: "Fire Risk", desc: "Forest fire susceptibility.", colors: ['#ffebee', '#e57373', '#c62828', '#b71c1c'] }
    };

    // --- 3. DATA LOADING & PRE-PROCESSING ---
    function init() {
        var promises = Object.keys(config).map(key => 
            fetch(config[key].file)
                .then(r => r.ok ? r.json() : null)
                .then(json => {
                    if(json) {
                        // Normalize Block Names & Detect Value Column
                        var col = detectColumn(json.features[0].properties, key);
                        json.features.forEach(f => {
                            f.properties._cleanVal = parseValue(f.properties[col]);
                            f.properties._blockName = normalizeName(f.properties);
                        });
                        appState.dataStore[key] = { json: json, col: col };
                    }
                })
        );

        Promise.all(promises).then(() => {
            populateBlockDropdown();
            console.log("System Ready. Data Loaded.");
        });
    }

    // Helper: Find value column
    function detectColumn(props, type) {
        var k = Object.keys(props);
        if(type === 'multi') return k.find(x => x.toLowerCase().includes('score')) || k[0];
        // Generic number finder
        for(let key of k) if(typeof props[key] === 'number') return key;
        return k.find(x => x.toLowerCase() !== 'objectid') || k[0];
    }

    // Helper: Normalize values
    function parseValue(v) {
        if(typeof v === 'string') {
            v = v.toLowerCase();
            if(v.includes('very high')) return 5;
            if(v.includes('high')) return 4;
            if(v.includes('mod')) return 3;
            if(v.includes('low')) return 2;
            return 1;
        }
        return parseFloat(v) || 0;
    }

    // Helper: Find block name
    function normalizeName(props) {
        var k = Object.keys(props).find(key => key.toLowerCase().includes('block'));
        return k ? props[k].trim() : "Unknown";
    }

    // --- 4. CORE RENDERING LOGIC ---

    // Triggered by Layer Buttons
    function setMode(layerKey) {
        appState.activeLayerKey = layerKey;
        // If a block is already selected, keep it focused
        renderMap();
        updateUI();
    }

    // Triggered by Dropdown
    function focusBlock(blockName) {
        appState.activeBlock = blockName === "" ? null : blockName;
        // If no layer is active, default to Multihazard
        if(!appState.activeLayerKey) appState.activeLayerKey = 'multi';
        renderMap();
        updateUI();
    }

    function resetMap() {
        appState.activeLayerKey = null;
        appState.activeBlock = null;
        document.getElementById('blockDropdown').value = "";
        if(appState.geoLayer) map.removeLayer(appState.geoLayer);
        document.getElementById('active-legend').style.display = 'none';
        document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
        map.setView([24.7914, 85.0002], 10);
    }

    function renderMap() {
        if(!appState.activeLayerKey) return;
        
        var dataObj = appState.dataStore[appState.activeLayerKey];
        var cfg = config[appState.activeLayerKey];
        if(!dataObj) { alert("Data not loaded for this layer"); return; }

        if(appState.geoLayer) map.removeLayer(appState.geoLayer);

        // Calculate Min/Max for color scale
        var vals = dataObj.json.features.map(f => f.properties._cleanVal);
        var min = Math.min(...vals);
        var max = Math.max(...vals);
        if(min === max) max = min + 1;

        appState.geoLayer = L.geoJson(dataObj.json, {
            style: function(feature) {
                var val = feature.properties._cleanVal;
                var bName = feature.properties._blockName;
                
                // SPOTLIGHT LOGIC
                var isTarget = (appState.activeBlock === bName);
                var isFocusMode = (appState.activeBlock !== null);
                
                var opacity = 0.65; // Default transparency for Satellite visibility
                var weight = 1;
                var color = '#fff';
                var dashArray = null;

                if (isFocusMode) {
                    if (isTarget) {
                        opacity = 0.85; // Target is clearer
                        weight = 3;     // Target has thick border
                        color = '#00bcd4'; // Cyan highlight
                    } else {
                        opacity = 0.1;  // Others are ghosted
                        weight = 0.5;
                        color = '#555';
                    }
                }

                return {
                    fillColor: getColor(val, min, max, cfg.colors),
                    weight: weight,
                    opacity: 1,
                    color: color,
                    dashArray: dashArray,
                    fillOpacity: opacity
                };
            },
            onEachFeature: function(feature, layer) {
                var bName = feature.properties._blockName;
                var val = Math.round(feature.properties._cleanVal * 100)/100;
                
                // Tooltip Logic:
                // If Focus Mode -> Only show tooltip for target (Permanent)
                // If District Mode -> Show tooltip on hover
                if (appState.activeBlock === bName) {
                    layer.bindTooltip(bName, { permanent: true, direction: "center", className: "focus-label" });
                    layer.openTooltip();
                } else {
                    layer.bindTooltip(`<b>${bName}</b><br>Val: ${val}`, { sticky: true, direction: "top" });
                }

                // Interaction
                layer.on('click', function() {
                    appState.activeBlock = bName;
                    document.getElementById('blockDropdown').value = bName;
                    renderMap();
                    updateUI();
                });
            }
        }).addTo(map);

        // Zoom Logic
        if(appState.activeBlock) {
            // Find layer for block
            var targetLayer = appState.geoLayer.getLayers().find(l => l.feature.properties._blockName === appState.activeBlock);
            if(targetLayer) map.fitBounds(targetLayer.getBounds(), { padding: [50, 50], maxZoom: 11 });
        } else {
            // map.fitBounds(appState.geoLayer.getBounds()); // Optional: Auto zoom to district
        }
    }

    function getColor(val, min, max, palette) {
        var t = (val - min) / (max - min);
        t = Math.max(0, Math.min(1, t));
        // Map t (0-1) to palette index
        var idx = Math.floor(t * (palette.length - 1));
        return palette[idx];
    }

    // --- 5. UI UPDATES ---
    function updateUI() {
        var cfg = config[appState.activeLayerKey];
        if(!cfg) return;

        // Active Buttons
        document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
        // (Simple check based on onclick attribute string match)
        document.querySelectorAll(`.layer-btn[onclick*="'${appState.activeLayerKey}'"]`).forEach(b => b.classList.add('active'));

        // Legend
        var leg = document.getElementById('active-legend');
        leg.style.display = 'block';
        document.getElementById('legend-title').innerText = cfg.title;
        document.getElementById('legend-desc').innerText = cfg.desc;
        document.getElementById('legend-bar').style.background = `linear-gradient(90deg, ${cfg.colors.join(', ')})`;

        // Value Display
        var valDisplay = document.getElementById('block-val-display');
        var valPlace = document.getElementById('val-placeholder');
        
        if(appState.activeBlock) {
            valDisplay.style.display = 'block';
            // Find value
            var feat = appState.dataStore[appState.activeLayerKey].json.features.find(f => f.properties._blockName === appState.activeBlock);
            valPlace.innerText = feat ? Math.round(feat.properties._cleanVal * 100)/100 : "N/A";
        } else {
            valDisplay.style.display = 'none';
        }
    }

    function populateBlockDropdown() {
        // Use 'multi' or first available dataset to get names
        var src = appState.dataStore['multi'] || appState.dataStore[Object.keys(appState.dataStore)[0]];
        if(!src) return;

        var names = src.json.features.map(f => f.properties._blockName).sort();
        // Unique
        names = [...new Set(names)];
        
        var sel = document.getElementById('blockDropdown');
        names.forEach(n => {
            var opt = document.createElement('option');
            opt.value = n;
            opt.innerText = n;
            sel.appendChild(opt);
        });
    }

    // Start
    init();

</script>
</body>
</html>